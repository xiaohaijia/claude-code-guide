# Claude Code 权限配置说明文档

> 创建日期: 2025-11-20
> 配置位置: `C:\Users\19043\.claude\`
> 适用系统: Windows 11

---

## 📋 目录

1. [配置文件清单](#配置文件清单)
2. [工作原理](#工作原理)
3. [权限级别说明](#权限级别说明)
4. [配置详解](#配置详解)
5. [使用示例](#使用示例)
6. [自定义配置](#自定义配置)
7. [常见问题](#常见问题)
8. [安全建议](#安全建议)

---

## 配置文件清单

已创建以下全局配置文件：

```
C:\Users\19043\.claude\
├── settings.json                    # 全局权限配置
├── hooks\
│   └── preToolUse.js               # 安全拦截 Hook
└── 权限配置说明.md                 # 本文档
```

---

## 工作原理

### 权限检查流程

```
用户请求 → PreToolUse Hook → Deny 规则 → Allow 规则 → Ask 规则 → 执行
            ↓                  ↓            ↓            ↓
         最高优先级          直接拒绝      自动通过      询问用户
```

### 双层防护机制

1. **第一层：settings.json 配置**
   - 基于规则的快速过滤
   - 支持通配符匹配
   - 配置简单，易于维护

2. **第二层：preToolUse.js Hook**
   - 动态安全检查（最可靠）
   - 支持复杂逻辑判断
   - 防御未知威胁

⚠️ **重要**：由于 `deny` 规则目前存在 bug（GitHub Issue #6699），**主要依靠 Hook 进行安全防护**。

---

## 权限级别说明

### 🟢 Allow（自动允许）

**特点**：
- 无需用户确认，自动执行
- 适用于频繁使用的安全命令
- 提高工作效率

**已配置的命令**：
- ✅ Git 查询：`git status`、`git diff`、`git log`、`git branch`
- ✅ Git 本地操作：`git add`、`git commit`、`git checkout`
- ✅ NPM 运行：`npm test`、`npm run dev/build/lint`
- ✅ 文件浏览：`ls`、`cat`、`pwd`、`tree`
- ✅ 读取代码文件：`.js`、`.ts`、`.py`、`.json` 等
- ✅ 读取配置文件：`package.json`、`.gitignore`、`README.md`

### 🟡 Ask（需要确认）

**特点**：
- 执行前需要用户确认
- 适用于中等风险操作
- 可快速批准

**已配置的命令**：
- ⚠️ 网络操作：`git push`、`git pull`、`git fetch`
- ⚠️ 包管理：`npm install`、`npm uninstall`
- ⚠️ 文件修改：`Write`、`Edit` 工具
- ⚠️ 敏感文件读取：`.env` 文件、`config` 目录

### 🔴 Deny（直接拒绝）

**特点**：
- 直接拒绝，无法执行
- 防止误操作
- 需手动修改配置才能执行

**已配置的命令**：
- 🚫 递归删除：`rm -rf`、`del /s`
- 🚫 强制 Git：`git reset --hard`、`git push --force`
- 🚫 危险下载：`curl | sh`、`wget | bash`
- 🚫 敏感文件：`*.key`、`*credentials*`、`*secret*`

### ⛔ Hook 拦截（极度危险）

**特点**：
- 由 Hook 动态检测并拦截
- 无法通过配置绕过
- 需要手动在终端执行

**拦截的命令**：
- ⛔ 系统级删除：`rm -rf /`、`format C:`
- ⛔ 网络执行：`curl | sh`、`Invoke-WebRequest | iex`
- ⛔ 数据库操作：`DROP DATABASE`、`TRUNCATE TABLE`
- ⛔ 系统操作：`shutdown`、`reboot`
- ⛔ 内网访问：`localhost`、`192.168.*`、`127.0.0.1`

---

## 配置详解

### settings.json 结构

```json
{
  "alwaysThinkingEnabled": true,
  "permissions": {
    "allow": [/* 自动允许的命令 */],
    "ask": [/* 需要确认的命令 */],
    "deny": [/* 直接拒绝的命令 */]
  }
}
```

### 通配符语法

| 模式 | 说明 | 示例 |
|------|------|------|
| `*` | 匹配任意字符 | `git add *` 匹配所有 git add 命令 |
| `**` | 匹配任意路径 | `Read(**/*.js)` 匹配所有 JS 文件 |
| `?` | 匹配单个字符 | `Read(test?.js)` 匹配 test1.js, test2.js |

### 工具名称格式

| 工具 | 格式 | 示例 |
|------|------|------|
| Bash | `Bash(命令)` | `Bash(npm test)` |
| Read | `Read(路径模式)` | `Read(**/*.json)` |
| Write | `Write(路径模式)` | `Write(**/*.md)` |
| Edit | `Edit(路径模式)` | `Edit(src/**/*.js)` |

---

## 使用示例

### 示例 1：查看项目状态（自动允许）

```bash
# Claude 执行以下命令无需确认
git status
git diff
ls -la
cat package.json
```

✅ **结果**：直接执行，无需用户确认

### 示例 2：推送代码（需要确认）

```bash
# Claude 尝试执行
git push origin main
```

⚠️ **结果**：弹出确认提示
```
Claude 想要执行: git push origin main
[ 允许 ] [ 拒绝 ] [ 总是允许 ]
```

### 示例 3：危险操作（Hook 拦截）

```bash
# Claude 尝试执行
rm -rf /important-folder
```

⛔ **结果**：被 Hook 拦截
```
🚫 极度危险命令被拦截
命令: rm -rf /important-folder
原因: 递归删除根目录或重要路径

如果确实需要执行，请手动在终端中操作。
```

### 示例 4：读取敏感文件（Hook 拦截）

```bash
# Claude 尝试读取
Read(.env)
```

🚫 **结果**：被 Hook 拦截
```
🚫 安全拦截：拒绝访问敏感文件
文件: .env
原因: 该文件可能包含敏感信息（密钥、密码、凭证等）
```

---

## 自定义配置

### 添加新的自动允许命令

编辑 `C:\Users\19043\.claude\settings.json`：

```json
{
  "permissions": {
    "allow": [
      // 原有配置...

      // 添加新命令
      "Bash(python *)",
      "Bash(pytest *)",
      "Read(**/*.py)"
    ]
  }
}
```

### 临时放宽权限（项目级）

在项目目录创建 `.claude/settings.local.json`：

```json
{
  "permissions": {
    "allow": [
      "Bash(git push origin dev)"  // 仅此项目允许
    ]
  }
}
```

### 添加自定义安全规则

编辑 `C:\Users\19043\.claude\hooks\preToolUse.js`：

```javascript
// 添加新的拦截规则
if (tool === 'Bash') {
  const command = parameters.command || '';

  // 阻止部署到生产环境
  if (command.includes('deploy') && command.includes('production')) {
    return {
      allowed: false,
      reason: '⛔ 禁止通过 Claude 部署到生产环境'
    };
  }
}
```

---

## 常见问题

### Q1: 为什么有些命令还是会询问我？

**A**: 可能原因：
1. 命令不在 `allow` 列表中
2. 命令匹配了 `ask` 或 `deny` 规则
3. Hook 进行了额外检查

**解决方案**：
- 检查 `settings.json` 配置
- 使用 `/permissions` 命令添加规则

### Q2: 如何完全信任 Claude（不推荐）？

**A**: 不推荐这样做，但如果确实需要：

```json
{
  "permissions": {
    "allow": ["**"],  // 允许所有操作（危险！）
    "ask": [],
    "deny": []
  }
}
```

并且删除或重命名 `hooks/preToolUse.js`

⚠️ **警告**：这会完全绕过安全检查，仅在隔离的测试环境中使用！

### Q3: deny 规则为什么不生效？

**A**: 这是 Claude Code 的已知 bug（GitHub Issue #6699）。

**解决方案**：
- 主要依靠 `preToolUse.js` Hook 进行防护
- deny 规则仅作为第二道防线
- 关注官方修复进展

### Q4: 如何查看当前权限配置？

**A**: 在 Claude Code 中执行：
```
/permissions
```

或直接查看文件：
```powershell
cat C:\Users\19043\.claude\settings.json
```

### Q5: 项目配置和全局配置冲突怎么办？

**A**: 优先级：
```
项目 .claude/settings.local.json > 项目 .claude/settings.json > 全局 ~/.claude/settings.json
```

项目配置会**覆盖**全局配置。

### Q6: Hook 报错怎么办？

**A**: 检查步骤：
1. 确认 Hook 文件语法正确（ES6 模块格式）
2. 查看错误日志
3. 临时禁用 Hook：重命名 `preToolUse.js` 为 `preToolUse.js.bak`

---

## 安全建议

### ✅ 推荐做法

1. **分层防护**
   - 全局配置：严格的安全基线
   - 项目配置：根据需求适度放宽
   - Hook：作为最后一道防线

2. **最小权限原则**
   - 只添加确实需要的命令到 `allow` 列表
   - 敏感操作始终保持在 `ask` 或 `deny` 列表

3. **定期审查**
   - 每月检查一次权限配置
   - 删除不再需要的规则

4. **测试环境使用**
   - 在测试项目中先验证配置
   - 确认无误后应用到生产项目

5. **版本控制**
   - 将项目级配置提交到 Git
   - 全局配置定期备份

### ⛔ 危险操作

1. **不要**设置 `"allow": ["**"]`（允许所有操作）
2. **不要**在生产环境禁用 Hook
3. **不要**将敏感文件路径添加到 `allow` 列表
4. **不要**盲目信任所有 Git 推送操作
5. **不要**允许从不信任的源执行脚本

### 🔒 敏感项目额外防护

对于包含敏感数据的项目，在项目目录创建严格配置：

**`.claude/settings.local.json`**:
```json
{
  "permissions": {
    "allow": [],  // 空白名单
    "ask": ["**"],  // 所有操作都询问
    "deny": [
      "Write(**)",
      "Edit(**/.env*)",
      "Bash(git push *)"
    ]
  }
}
```

---

## 配置文件位置速查

| 配置类型 | 路径 | 作用域 |
|---------|------|--------|
| 全局配置 | `C:\Users\19043\.claude\settings.json` | 所有项目 |
| 全局 Hook | `C:\Users\19043\.claude\hooks\preToolUse.js` | 所有项目 |
| 项目配置 | `项目/.claude/settings.json` | 单个项目 |
| 项目本地配置 | `项目/.claude/settings.local.json` | 单个项目（优先级最高） |
| 项目 Hook | `项目/.claude/hooks/preToolUse.js` | 单个项目 |

---

## 更新日志

### v1.0 (2025-11-20)

- ✅ 创建全局 `settings.json` 配置
- ✅ 创建全局 `preToolUse.js` Hook
- ✅ 配置常用安全命令自动允许
- ✅ 配置敏感操作需要确认
- ✅ 配置危险命令直接拦截
- ✅ 添加文件读写保护
- ✅ 添加网络访问保护
- ✅ 添加数据库操作保护

---

## 参考资源

- [Claude Code 官方文档](https://docs.claude.com/en/docs/claude-code)
- [权限配置官方指南](https://docs.claude.com/en/docs/claude-code/settings)
- [SDK 权限处理](https://docs.claude.com/en/docs/claude-code/sdk/sdk-permissions)
- [GitHub Issue #6699 - Deny 规则 Bug](https://github.com/anthropics/claude-code/issues/6699)

---

## 技术支持

如遇到问题：
1. 查看本文档的"常见问题"章节
2. 访问 [Claude Code GitHub Issues](https://github.com/anthropics/claude-code/issues)
3. 使用 `/feedback` 命令提交反馈

---

**配置创建完成！享受更流畅的 Claude Code 体验吧！** 🎉
